<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meal Planner</title>
    <link rel="stylesheet" type="text/css" href="index.css">
</head>
<body>
    <!-- Meal Plan Container -->
    <div class="meal-plan" id="meal-plan"></div>

    <!-- Aggregation Section with Tabs -->
    <div id="aggregation-section">
        <div class="tabs">
            <button class="tab-button active" data-tab="ingredients">Ingredients</button>
            <button class="tab-button" data-tab="nutrients">Nutrients</button>
        </div>
        <div class="tab-content active" id="ingredients-tab">
            <aggregated-food-items id="aggregated-food-display"></aggregated-food-items>
        </div>
        <div class="tab-content" id="nutrients-tab">
            <nutrient-html id="aggregated-nutrients-display" show-calorie-button></nutrient-html>
        </div>
    </div>

    <!-- Overlay and Popups -->
    <div id="overlay" class="overlay"></div>
    <div id="popup" class="popup">
        <span class="popup-close">×</span>
        <div id="popup-content"></div>
    </div>
    <div id="nutrient-popup" class="popup" style="display: none;">
        <span class="popup-close">×</span>
        <nutrient-html id="nutrient-display"></nutrient-html>
    </div>

    <!-- Main JavaScript Logic -->
    <script type="module">
        import * as api from './src/api.js';
        window.api = api;
    
        // Helper Functions
        function getMealIndices(mealKey) {
            const [day, meal, version] = mealKey.split('-');
            const dayIndex = api.days.indexOf(day);
            const mealIndex = api.meals.indexOf(meal);
            const versionIndex = parseInt(version, 10);
            return { dayIndex, mealIndex, versionIndex };
        }
    
        function getMealKey(dayIndex, mealIndex, versionIndex) {
            const day = api.days[dayIndex];
            const meal = api.meals[mealIndex];
            const version = versionIndex.toString();
            return `${day}-${meal}-${version}`;
        }
    
        function encodeSelections() {
            const selections = [];
            for (const [mealKey, quantity] of api.mealQuantities) {
                if (quantity > 0) {
                    const { dayIndex, mealIndex, versionIndex } = getMealIndices(mealKey);
                    selections.push(`${dayIndex}-${mealIndex}-${versionIndex}-${quantity}`);
                }
            }
            return selections.join('|');
        }
    
        function decodeSelections(encoded) {
            const parts = encoded.split('|');
            const mealQuantities = new Map();
            for (const part of parts) {
                if (part) {
                    const [dayIndex, mealIndex, versionIndex, quantity] = part.split('-').map(Number);
                    const mealKey = getMealKey(dayIndex, mealIndex, versionIndex);
                    mealQuantities.set(mealKey, quantity);
                }
            }
            return mealQuantities;
        }
    
        function cleanTitle(title) {
            return title.replace(/^#+\s*/, '');
        }
    
        async function renderMealPlan() {
            const mealPlanContainer = document.getElementById('meal-plan');
            const overlay = document.getElementById('overlay');
            const fragment = document.createDocumentFragment();
    
            for (const day of api.days) {
                if (api.data[day]) {
                    const dayDiv = document.createElement('div');
                    dayDiv.classList.add('day');
    
                    // Create a header container for the title and refresh button
                    const dayHeader = document.createElement('div');
                    dayHeader.style.display = 'flex';
                    dayHeader.style.alignItems = 'center';
    
                    const dayTitle = document.createElement('h2');
                    dayTitle.textContent = day.charAt(0).toUpperCase() + day.slice(1);
                    dayHeader.appendChild(dayTitle);
    
                    // Add the refresh button
                    const refreshButton = document.createElement('button');
                    refreshButton.textContent = '↻'; // Unicode refresh symbol
                    refreshButton.title = 'Reset selections for this day';
                    refreshButton.style.marginLeft = '10px';
                    refreshButton.style.cursor = 'pointer';
                    refreshButton.addEventListener('click', () => {
                        resetDaySelections(day);
                    });
                    dayHeader.appendChild(refreshButton);
    
                    dayDiv.appendChild(dayHeader);
    
                    for (const meal of api.meals) {
                        if (api.data[day][meal]) {
                            const mealDiv = document.createElement('div');
                            mealDiv.classList.add('schedule');
                            const mealTitle = document.createElement('h3');
                            mealTitle.textContent = meal.charAt(0).toUpperCase() + meal.slice(1);
                            mealDiv.appendChild(mealTitle);
    
                            const mealsDiv = document.createElement('div');
                            mealsDiv.classList.add('meals');
    
                            for (const version of Object.keys(api.data[day][meal])) {
                                const mealElement = document.createElement('meal-element');
                                mealElement.setAttribute('day', day);
                                mealElement.setAttribute('meal', meal);
                                mealElement.setAttribute('version', version);
                                mealElement.setAttribute('title', cleanTitle(api.data[day][meal][version].title));
                                mealsDiv.appendChild(mealElement);
                            }
                            mealDiv.appendChild(mealsDiv);
                            dayDiv.appendChild(mealDiv);
                        }
                    }
                    fragment.appendChild(dayDiv);
                }
            }
    
            mealPlanContainer.appendChild(fragment);
    
            // Close popups
            document.querySelectorAll('.popup-close').forEach(closeButton => {
                closeButton.addEventListener('click', () => {
                    const popup = closeButton.closest('.popup');
                    if (popup) {
                        popup.style.display = 'none';
                        overlay.style.display = 'none';
                    }
                });
            });
    
            document.querySelectorAll('.popup').forEach(popup => {
                popup.addEventListener('click', (event) => {
                    if (event.target.tagName.toLowerCase() !== "food-nutrient-link") {
                        const nutrientLinks = popup.querySelectorAll('food-nutrient-link');
                        nutrientLinks.forEach(link => {
                            if (link.hidePopup) {
                                link.hidePopup();
                            }
                        });
                    }
                });
            });
    
            overlay.addEventListener('click', () => {
                document.querySelectorAll('.popup').forEach(popup => {
                    popup.style.display = 'none';
                });
                document.querySelectorAll('food-nutrient-link').forEach(link => {
                    if (link.hidePopup) {
                        link.hidePopup();
                    }
                });
                overlay.style.display = 'none';
            });
        }
    
        // Function to reset selections for a specific day
        function resetDaySelections(day) {
            const meals = document.querySelectorAll(`meal-element[day="${day}"]`);
            meals.forEach(meal => {
                const mealKey = `${meal.getAttribute('day')}-${meal.getAttribute('meal')}-${meal.getAttribute('version')}`;
                api.mealQuantities.set(mealKey, 0);
                const shadowRoot = meal.shadowRoot;
                const quantityCircle = shadowRoot.querySelector('.quantity-circle');
                const customDropdown = shadowRoot.querySelector('.custom-dropdown');
                const mealDiv = shadowRoot.querySelector('.meal');
                quantityCircle.textContent = '0';
                quantityCircle.classList.remove('active');
                quantityCircle.style.display = 'block';
                customDropdown.style.display = 'none';
                mealDiv.classList.remove('selected');
            });
            window.calculateAggregations();
        }
    
        api.fetchData().then(() => {
            console.log("fetchData resolved");
            renderMealPlan().then(() => {
                console.log("Meal plan rendered successfully.");
                
                const fragment = location.hash.slice(1); // Get URL fragment (after #)
                let selections;
                
                if (fragment) {
                    // If URL fragment exists, use it
                    selections = decodeSelections(fragment);
                } else {
                    // If URL is blank, check the cookie
                    const cookieSelections = getCookie('mealSelections');
                    if (cookieSelections) {
                        selections = decodeSelections(cookieSelections);
                    } else {
                        selections = new Map(); // Default to empty selections
                    }
                }
                
                // Apply the selections
                api.mealQuantities = selections;
                
                // Refresh meal elements
                document.querySelectorAll('meal-element').forEach(meal => {
                    meal.refresh();
                });
                
                // Recalculate aggregations
                window.calculateAggregations();
            }).catch(error => {
                console.error("Error rendering meal plan:", error);
            });
        }).catch(error => {
            console.error("Error fetching data:", error);
        });
    
        function parseIngredients(content) {
            const matches = [];
            for (const [quantity, ingredientName, originalText] of api.parseIngredients(content)) {
                matches.push([quantity, ingredientName]);
            }
            return matches;
        }
    
        async function calculateAggregations() {
            const aggregatedFoodDisplay = document.getElementById('aggregated-food-display');
            const aggregatedNutrientsDisplay = document.getElementById('aggregated-nutrients-display');
            const allFoodItems = [];
            
            for (const [mealKey, quantity] of api.mealQuantities) {
                if (quantity > 0) {
                    const [day, mealTime, version] = mealKey.split('-');
                    const content = api.data[day][mealTime][version].content;
                    const ingredients = parseIngredients(content);
                    for (const [ingQuantity, ingredientName] of ingredients) {
                        const totalQuantity = ingQuantity * quantity;
                        allFoodItems.push({ foodName: ingredientName, quantity: totalQuantity });
                    }
                }
            }
            
            aggregatedFoodDisplay.setAttribute('food-list', JSON.stringify(allFoodItems));
            aggregatedNutrientsDisplay.setAttribute('food-list', JSON.stringify(allFoodItems));
            
            // Save selections to a cookie
            const encoded = encodeSelections();
            setCookie('mealSelections', encoded, 7); // Save for 7 days
        }
    
        // Set a cookie with a name, value, and expiration in days
        function setCookie(name, value, days) {
            console.log("set");
            const date = new Date();
            date.setTime(date.getTime() + (days * 24 * 60 * 60 * 1000));
            const expires = "expires=" + date.toUTCString();
            document.cookie = name + "=" + value + ";" + expires + ";path=/";
        }
    
        // Get a cookie by name
        function getCookie(name) {
            const nameEQ = name + "=";
            const ca = document.cookie.split(';');
            for (let i = 0; i < ca.length; i++) {
                let c = ca[i];
                while (c.charAt(0) === ' ') c = c.substring(1, c.length);
                if (c.indexOf(nameEQ) === 0) return c.substring(nameEQ.length, c.length);
            }
            return null;
        }
    
        window.calculateAggregations = calculateAggregations;
    
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                button.classList.add('active');
                const tabId = button.getAttribute('data-tab');
                document.getElementById(`${tabId}-tab`).classList.add('active');
            });
        });
    </script>

    <!-- Additional JavaScript Files -->
    <script src="./src/api.js" type="module"></script>
    <script src="./src/meal-element.js" type="module"></script>
    <script src="./src/nutrient-html.js" type="module"></script>
    <script src="./src/food-nutrient-link.js" type="module"></script>
    <script src="./src/aggregated-food-items.js" type="module"></script>
</body>
</html>